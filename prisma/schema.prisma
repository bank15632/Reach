// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== USER & AUTH ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  phone         String?
  avatar        String?
  role          Role      @default(USER)
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  addresses     Address[]
  orders        Order[]
  partnerInfo   Partner?
  rewardPoints  Int       @default(0)
  sessions      Session[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

enum Role {
  USER
  PARTNER
  ADMIN
}

model Address {
  id          String  @id @default(cuid())
  userId      String
  label       String  // e.g., "Home", "Work"
  fullName    String
  phone       String
  address     String
  subDistrict String
  district    String
  province    String
  postalCode  String
  isDefault   Boolean @default(false)

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  @@map("addresses")
}

// ==================== PRODUCTS ====================

model Product {
  id          String   @id @default(cuid())
  sku         String   @unique
  name        String
  nameTh      String
  description String?
  descriptionTh String?
  price       Float
  salePrice   Float?
  category    Category
  brand       String?
  images      String[] // Array of image URLs
  inStock     Boolean  @default(true)
  stockCount  Int      @default(0)
  featured    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  variants    ProductVariant[]
  orderItems  OrderItem[]
  bundleItems BundleItem[]

  @@map("products")
}

model ProductVariant {
  id        String  @id @default(cuid())
  productId String
  name      String  // e.g., "Size", "Color"
  value     String  // e.g., "M", "Red"
  price     Float?  // Override price if different
  stock     Int     @default(0)

  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@map("product_variants")
}

enum Category {
  RACKETS
  SHOES
  SPORTSWEAR
  SUPPLEMENTS
  ACCESSORIES
}

model Bundle {
  id          String   @id @default(cuid())
  name        String
  nameTh      String
  description String?
  price       Float
  originalPrice Float
  images      String[]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items BundleItem[]
  orderItems OrderItem[]

  @@map("bundles")
}

model BundleItem {
  id        String @id @default(cuid())
  bundleId  String
  productId String
  quantity  Int    @default(1)

  bundle  Bundle  @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("bundle_items")
}

// ==================== ORDERS ====================

model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique
  userId          String
  addressId       String?
  status          OrderStatus @default(PENDING)
  subtotal        Float
  discount        Float       @default(0)
  shippingFee     Float       @default(0)
  total           Float

  // Partner/Discount code
  partnerCodeId   String?
  partnerCode     PartnerCode? @relation(fields: [partnerCodeId], references: [id])

  // Payment
  paymentMethod   PaymentMethod?
  paymentStatus   PaymentStatus @default(PENDING)
  paidAt          DateTime?

  // Shipping
  shippingMethod  String?
  trackingNumber  String?
  shippedAt       DateTime?
  deliveredAt     DateTime?

  // Reward points earned
  pointsEarned    Int         @default(0)
  pointsUsed      Int         @default(0)

  notes           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user     User        @relation(fields: [userId], references: [id])
  address  Address?    @relation(fields: [addressId], references: [id])
  items    OrderItem[]

  @@map("orders")
}

model OrderItem {
  id         String  @id @default(cuid())
  orderId    String
  productId  String?
  variantId  String?
  bundleId   String?
  quantity   Int
  unitPrice  Float
  totalPrice Float

  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product?        @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])
  bundle  Bundle?         @relation(fields: [bundleId], references: [id])

  @@map("order_items")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CREDIT_CARD
  BANK_TRANSFER
  PROMPTPAY
  COD
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

// ==================== PARTNER/AFFILIATE ====================

model Partner {
  id              String        @id @default(cuid())
  userId          String        @unique
  affiliateCode   String        @unique // e.g., "REACH001"
  status          PartnerStatus @default(PENDING)

  // Commission
  totalCommission     Float @default(0)
  availableCommission Float @default(0)
  paidCommission      Float @default(0)
  commissionRate      Float @default(0.1) // 10%

  // Points & Levels
  partnerPoints   Float   @default(0)
  currentLevel    Int     @default(0)
  claimedLevels   Int[]   @default([])

  // Stats
  totalSales      Float   @default(0)
  totalOrders     Int     @default(0)

  // Social media
  socialMedia     Json?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  codes           PartnerCode[]
  withdrawals     PartnerWithdrawal[]
  rewardClaims    PartnerRewardClaim[]

  @@map("partners")
}

model PartnerCode {
  id                 String   @id @default(cuid())
  partnerId          String
  code               String   @unique
  discountPercent    Int
  expiryDate         DateTime?
  maxUses            Int?
  usedCount          Int      @default(0)
  applicableProducts String[] // "all" or array of product IDs
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())

  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  orders  Order[]

  @@map("partner_codes")
}

model PartnerWithdrawal {
  id          String           @id @default(cuid())
  partnerId   String
  amount      Float
  status      WithdrawalStatus @default(PENDING)
  bankName    String
  bankAccount String
  bankHolder  String
  processedAt DateTime?
  notes       String?
  createdAt   DateTime         @default(now())

  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@map("partner_withdrawals")
}

model PartnerRewardClaim {
  id          String   @id @default(cuid())
  partnerId   String
  level       Int
  rewardName  String
  rewardValue Float
  claimedAt   DateTime @default(now())

  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@map("partner_reward_claims")
}

enum PartnerStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  REJECTED
}

// ==================== TOURNAMENTS ====================

model Tournament {
  id          String   @id @default(cuid())
  name        String
  nameTh      String
  description String?
  location    String
  startDate   DateTime
  endDate     DateTime
  status      TournamentStatus @default(UPCOMING)
  bannerImage String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  matches TournamentMatch[]

  @@map("tournaments")
}

model TournamentMatch {
  id            String   @id @default(cuid())
  tournamentId  String
  round         String
  roundTh       String
  category      String
  categoryTh    String
  court         String
  time          String
  date          DateTime

  // Player 1
  player1         String
  player1Nickname String?
  player1Photo    String?
  player1Gender   String?
  player1Birthdate DateTime?
  player1Seed     Int?

  // Player 1 Partner (for doubles)
  player1Partner         String?
  player1PartnerNickname String?
  player1PartnerPhoto    String?
  player1PartnerGender   String?
  player1PartnerBirthdate DateTime?

  // Player 2
  player2         String
  player2Nickname String?
  player2Photo    String?
  player2Gender   String?
  player2Birthdate DateTime?
  player2Seed     Int?

  // Player 2 Partner (for doubles)
  player2Partner         String?
  player2PartnerNickname String?
  player2PartnerPhoto    String?
  player2PartnerGender   String?
  player2PartnerBirthdate DateTime?

  // Scores (JSON array of { player1: number, player2: number })
  scores        Json?
  winner        Int?      // 1 or 2
  status        MatchStatus @default(SCHEDULED)
  liveStreamUrl String?

  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  @@map("tournament_matches")
}

enum TournamentStatus {
  UPCOMING
  ONGOING
  COMPLETED
}

enum MatchStatus {
  SCHEDULED
  LIVE
  COMPLETED
}

// ==================== ARTICLES ====================

model Article {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  titleTh     String
  excerpt     String?
  excerptTh   String?
  content     String
  contentTh   String
  coverImage  String?
  category    String
  tags        String[]
  authorName  String
  authorPhoto String?
  published   Boolean  @default(false)
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("articles")
}
