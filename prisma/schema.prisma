// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ==================== USER & AUTH ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  phone         String?
  avatar        String?
  role          Role      @default(USER)
  adminPermissions AdminPermission[] @default([])
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  addresses     Address[]
  orders        Order[]
  partnerInfo   Partner?
  rewardPoints  Int       @default(0)
  sessions      Session[]
  
  // Auction relations
  wonAuctions   Auction[] @relation("AuctionWinner")
  bids          Bid[]
  blacklist     BidderBlacklist?
  payments      Payment[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

enum Role {
  USER
  PARTNER
  ADMIN
  SUPER_ADMIN
}

enum AdminPermission {
  VIEW_DASHBOARD
  MANAGE_PRODUCTS
  MANAGE_ORDERS
  MANAGE_USERS
  MANAGE_PARTNERS
  MANAGE_ARTICLES
  MANAGE_AUCTIONS
}

model Address {
  id          String  @id @default(cuid())
  userId      String
  label       String  // e.g., "Home", "Work"
  fullName    String
  phone       String
  address     String  // Street address line 1
  address2    String? // Street address line 2 (optional)
  city        String  // City or district
  state       String? // State/Province/Region (optional for some countries)
  postalCode  String
  country     String  @default("TH") // ISO country code
  
  // Legacy Thai address fields (for backward compatibility)
  subDistrict String?
  district    String?
  province    String?
  
  isDefault   Boolean @default(false)

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  @@map("addresses")
}

// ==================== PRODUCTS ====================

model Product {
  id          String   @id @default(cuid())
  sku         String   @unique
  name        String
  nameTh      String
  description String?
  descriptionTh String?
  price       Float
  salePrice   Float?
  category    Category
  brand       String?
  images      String[] // Array of image URLs
  inStock     Boolean  @default(true)
  stockCount  Int      @default(0)
  featured    Boolean  @default(false)
  weight      Float?   // Weight in kg for shipping calculation
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  variants    ProductVariant[]
  orderItems  OrderItem[]
  bundleItems BundleItem[]
  auctions    Auction[]

  @@map("products")
}

model ProductVariant {
  id        String  @id @default(cuid())
  productId String
  name      String  // e.g., "Size", "Color"
  value     String  // e.g., "M", "Red"
  price     Float?  // Override price if different
  stock     Int     @default(0)

  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@map("product_variants")
}

enum Category {
  RACKETS
  SHOES
  SPORTSWEAR
  SUPPLEMENTS
  ACCESSORIES
}

model Bundle {
  id          String   @id @default(cuid())
  name        String
  nameTh      String
  description String?
  price       Float
  originalPrice Float
  images      String[]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items BundleItem[]
  orderItems OrderItem[]

  @@map("bundles")
}

model BundleItem {
  id        String @id @default(cuid())
  bundleId  String
  productId String
  quantity  Int    @default(1)

  bundle  Bundle  @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("bundle_items")
}

// ==================== ORDERS ====================

model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique
  userId          String
  addressId       String?
  status          OrderStatus @default(PENDING)
  subtotal        Float
  discount        Float       @default(0)
  shippingFee     Float       @default(0)
  total           Float

  // Partner/Discount code
  partnerCodeId   String?
  partnerCode     PartnerCode? @relation(fields: [partnerCodeId], references: [id])

  // Payment
  paymentMethod   PaymentMethod?
  paymentStatus   PaymentStatus @default(PENDING)
  paidAt          DateTime?

  // Shipping
  shippingMethod  String?
  trackingNumber  String?
  shippedAt       DateTime?
  deliveredAt     DateTime?

  // Reward points earned
  pointsEarned    Int         @default(0)
  pointsUsed      Int         @default(0)

  notes           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user     User        @relation(fields: [userId], references: [id])
  address  Address?    @relation(fields: [addressId], references: [id])
  items    OrderItem[]

  @@map("orders")
}

model OrderItem {
  id         String  @id @default(cuid())
  orderId    String
  productId  String?
  variantId  String?
  bundleId   String?
  quantity   Int
  unitPrice  Float
  totalPrice Float

  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product?        @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])
  bundle  Bundle?         @relation(fields: [bundleId], references: [id])

  @@map("order_items")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CREDIT_CARD
  BANK_TRANSFER
  PROMPTPAY
  COD
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

// ==================== PARTNER/AFFILIATE ====================

model Partner {
  id              String        @id @default(cuid())
  userId          String        @unique
  affiliateCode   String        @unique // e.g., "REACH001"
  status          PartnerStatus @default(PENDING)

  // Commission
  totalCommission     Float @default(0)
  availableCommission Float @default(0)
  paidCommission      Float @default(0)
  commissionRate      Float @default(0.1) // 10%

  // Points & Levels
  partnerPoints   Float   @default(0)
  currentLevel    Int     @default(0)
  claimedLevels   Int[]   @default([])

  // Stats
  totalSales      Float   @default(0)
  totalOrders     Int     @default(0)

  // Social media
  socialMedia     Json?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  codes           PartnerCode[]
  withdrawals     PartnerWithdrawal[]
  rewardClaims    PartnerRewardClaim[]

  @@map("partners")
}

model PartnerCode {
  id                 String   @id @default(cuid())
  partnerId          String
  code               String   @unique
  discountPercent    Int
  expiryDate         DateTime?
  maxUses            Int?
  usedCount          Int      @default(0)
  applicableProducts String[] // "all" or array of product IDs
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())

  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  orders  Order[]

  @@map("partner_codes")
}

model PartnerWithdrawal {
  id          String           @id @default(cuid())
  partnerId   String
  amount      Float
  status      WithdrawalStatus @default(PENDING)
  bankName    String
  bankAccount String
  bankHolder  String
  processedAt DateTime?
  notes       String?
  createdAt   DateTime         @default(now())

  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@map("partner_withdrawals")
}

model PartnerRewardClaim {
  id          String   @id @default(cuid())
  partnerId   String
  level       Int
  rewardName  String
  rewardValue Float
  claimedAt   DateTime @default(now())

  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@map("partner_reward_claims")
}

enum PartnerStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  REJECTED
}

// ==================== AUCTIONS ====================

model Auction {
  id              String        @id @default(cuid())
  productId       String?       // Optional: link to existing product
  title           String
  titleTh         String
  description     String?
  descriptionTh   String?
  images          String[]      @default([])
  startPrice      Float         // Starting bid price in THB
  reservePrice    Float?        // Minimum price to sell (optional)
  currentPrice    Float         // Current highest bid
  bidIncrement    Float         @default(100) // Minimum bid increment
  startTime       DateTime
  endTime         DateTime
  status          AuctionStatus @default(SCHEDULED)
  
  // Winner info (set when auction ends)
  winnerId        String?
  winningBid      Float?
  
  // Payment tracking
  paymentDeadline DateTime?     // Deadline for winner to pay
  paymentStatus   AuctionPaymentStatus @default(PENDING)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  product         Product?      @relation(fields: [productId], references: [id])
  winner          User?         @relation("AuctionWinner", fields: [winnerId], references: [id])
  bids            Bid[]
  
  @@map("auctions")
}

model Bid {
  id         String   @id @default(cuid())
  auctionId  String
  userId     String
  amount     Float
  isWinning  Boolean  @default(false)
  createdAt  DateTime @default(now())
  
  auction    Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("bids")
}

model BidderBlacklist {
  id        String   @id @default(cuid())
  userId    String   @unique
  reason    String
  unpaidAuctions Int @default(1)
  createdAt DateTime @default(now())
  expiresAt DateTime? // Optional: temporary blacklist
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("bidder_blacklist")
}

enum AuctionStatus {
  SCHEDULED   // Not started yet
  ACTIVE      // Currently accepting bids
  ENDED       // Bidding ended, awaiting payment
  COMPLETED   // Paid and fulfilled
  CANCELLED   // Cancelled by admin
  NO_BIDS     // Ended with no bids
  UNPAID      // Winner didn't pay
}

enum AuctionPaymentStatus {
  PENDING     // Awaiting payment
  PAID        // Payment received
  FAILED      // Payment failed/declined
  REFUNDED    // Payment refunded
}

// ==================== SHIPPING ====================

model ShippingZone {
  id          String   @id @default(cuid())
  name        String   // e.g., "Asia Pacific", "Europe", "North America"
  countries   String[] // ISO country codes: ["US", "CA", "MX"]
  baseRate    Float    // Base shipping rate in THB
  perKgRate   Float    // Additional rate per kg
  freeShippingThreshold Float? // Order total for free shipping
  estimatedDays String  // e.g., "5-7 business days"
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("shipping_zones")
}

// ==================== PAYMENTS ====================

model Payment {
  id              String        @id @default(cuid())
  orderId         String?
  auctionId       String?
  userId          String
  amount          Float
  currency        String        @default("THB")
  amountUsd       Float?        // Converted amount for reference
  exchangeRate    Float?        // Exchange rate at time of payment
  
  provider        PaymentProvider
  providerId      String?       // Stripe/PayPal transaction ID
  status          PaymentStatus @default(PENDING)
  
  metadata        Json?         // Additional payment info
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  user            User          @relation(fields: [userId], references: [id])
  
  @@map("payments")
}

enum PaymentProvider {
  STRIPE
  PAYPAL
  BANK_TRANSFER
  PROMPTPAY
}

// ==================== EMAIL NOTIFICATIONS ====================

model EmailLog {
  id          String    @id @default(cuid())
  userId      String?
  email       String
  type        EmailType
  subject     String
  status      EmailStatus @default(PENDING)
  sentAt      DateTime?
  error       String?
  metadata    Json?
  createdAt   DateTime  @default(now())
  
  @@map("email_logs")
}

enum EmailType {
  ORDER_CONFIRMATION
  ORDER_SHIPPED
  ORDER_DELIVERED
  AUCTION_OUTBID
  AUCTION_WON
  AUCTION_PAYMENT_REMINDER
  PASSWORD_RESET
  WELCOME
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
}

// ==================== ARTICLES ====================

model Article {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  titleTh     String
  excerpt     String?
  excerptTh   String?
  coverImage  String?
  heroImage   String?
  image       String?
  category    String
  categoryTh  String
  sections    Json?
  content     String?
  contentTh   String?
  tags        String[]
  authorName  String
  authorPhoto String?
  published   Boolean  @default(false)
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("articles")
}

model InstagramPost {
  id        String   @id @default(cuid())
  imageUrl  String
  handle    String?
  link      String?
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, sortOrder])
  @@map("instagram_posts")
}
